{
    "trigger": {
      "schedule": {
        "interval": "2m"
      }
    },
    "input": {
      "search": {
        "request": {
          "search_type": "query_then_fetch",
          "indices": [
            "filebeat-*"
          ],
          "rest_total_hits_as_int": true,
          "body": {
            "_source": [
              "@timestamp",
              "message"
            ],
            "sort": [
              {
                "@timestamp": "asc"
              }
            ],
            "query": {
              "bool": {
                "must": [
                  {
                    "regexp": {
                      "container.name": ".*app.*"
                    }
                  }
                ],
                "should": [
                  {
                    "match": {
                      "message": "Exiting"
                    }
                  },
                  {
                    "match": {
                      "message": "Aborted"
                    }
                  }
                ],
                "filter": {
                  "range": {
                    "@timestamp": {
                      "gte": "{{ctx.trigger.scheduled_time}}||-2m",
                      "lte": "{{ctx.trigger.scheduled_time}}",
                      "format": "strict_date_time||epoch_millis"
                    }
                  }
                },
                "minimum_should_match" : 1
              }
            }
          }
        }
      }
    },
    "condition": {
      "script": {
        "source": "if (ctx.payload.hits.total >= params.threshold) { return true; } return false;",
        "lang": "painless",
        "params": {
          "threshold": 1
        }
      }
    },
    "actions": {
      "webhook_1": {
        "webhook": {
          "scheme": "https",
          "host": "api.chatwork.com",
          "port": 443,
          "method": "post",
          "path": "v2/rooms/{{replace_chatwork_room_id}}/messages",
          "params": {
            "body": "[info][title]Alert Monitoring - {{ctx.metadata.name}}[/title]â–  Trigger Time: {{ctx.payload.executed_time}}\nâ–  Occurred Times: {{ctx.payload.total}}\nâ–  Detail: {{ctx.payload.detail}}\nâ–  Filter Link: https://kibana.example.com[/info]"
          },
          "headers": {
            "X-ChatWorkToken": "{{replace_chatwork_api_secret_token}}"
          }
        }
      }
    },
    "transform": {
      "script": {
        "source": "HashMap result = new HashMap(); result.total = ctx.payload.hits.total; ArrayList docs = ctx.payload.hits.hits; def execution_datetime = ZonedDateTime.ofInstant(ctx.execution_time.toInstant(), ctx.execution_time.getZone()); result.executed_time = DateTimeFormatter.RFC_1123_DATE_TIME.format(execution_datetime); result.docs = new ArrayList(); result.detail = ''; for (int i = 0; i < docs.length; i++) { result.docs.add(docs[i]._source); result.detail += '[code]ðŸ— ' + docs[i]._id + '\nâ° ' + docs[i]._source['@timestamp'] + '\nðŸ“„ ' + docs[i]._source['message'] + '[/code]' } return result;",
        "lang": "painless",
        "params": {
          "threshold": 1
        }
      }
    }
  }
